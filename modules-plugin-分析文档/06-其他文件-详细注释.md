# 其他文件 - 详细注释版

## 1. ClassConstant.groovy - 常量定义

```groovy
// 包声明
package com.beyondxia.plugin.constant

/**
 * ClassConstant 类
 * 
 * 定义插件中使用的常量
 * 这些常量用于标识目标类和方法的名称
 */
class ClassConstant {

    // ServiceHelper.class 的文件路径（在 JAR 中的路径）
    // 这个类会被修改，注入自动注册代码
    public static final String INIT_CLASS_FILE_NAME = "com/beyondxia/modules/ServiceHelper.class"
    
    // ServiceHelper 类的完整类名
    public static final String INIT_CLASS_NAME = "com.beyondxia.modules.ServiceHelper"
    
    // 服务类的根包名
    // 只有这个包下的类才会被自动注册
    public static final String SERVICE_ROOT_PACKAGE = "com/beyondxia/modules_interface_library"
    
    // 初始化方法名
    // 这个方法会被注入注册代码
    public static final String SERVICE_INIT_METHOD = "pluginRegisterClassName"
    
    // 注册方法名
    // 这个方法会被调用，用于注册服务类
    public static final String SERVICE_DO_REGISTER_METHOD = "pluginRegister"

}
```

### 常量说明

- **INIT_CLASS_FILE_NAME**：ServiceHelper.class 在 JAR 中的路径，用于定位需要修改的文件
- **INIT_CLASS_NAME**：ServiceHelper 的完整类名，用于 ASM 字节码注入
- **SERVICE_ROOT_PACKAGE**：服务类的根包名，用于过滤需要注册的类
- **SERVICE_INIT_METHOD**：初始化方法名，这个方法会被注入注册代码
- **SERVICE_DO_REGISTER_METHOD**：注册方法名，用于实际注册服务

---

## 2. ConfigExtention.groovy - 配置扩展

```groovy
/**
 * ConfigExtention 类
 * 
 * 定义插件的配置选项
 * 用户可以在 build.gradle 中使用 modulesConfig {} 块来配置这些选项
 */
class ConfigExtention {
    // 排除的 JAR 包列表
    // 这些 JAR 包不会被处理
    // 例如：excludeJars = ['xxx.jar', 'yyy.jar']
    String[] excludeJars = []
    
    // 包含的类包名列表
    // 只有这些包下的类才会被处理
    // 例如：includeClassPackage = ['com.xxx', 'com.yyy']
    String[] includeClassPackage = []
    
    // 是否启用自动注册功能
    // true：启用，会在编译时自动注册服务类
    // false：禁用，需要手动注册
    boolean registerWithPlugin = false
    
    // 业务匹配字符串列表
    // 用于过滤需要处理的 JAR 包
    // 只有包含这些字符串的 JAR 包才会被处理
    // 例如：businessMatchStrings = ['business', 'module']
    String[] businessMatchStrings = []
}
```

### 配置示例

```groovy
modulesConfig {
    // 排除系统库
    excludeJars = ['android-support-v4.jar']
    
    // 只处理指定包下的类
    includeClassPackage = ['com.xxx.business', 'com.yyy.module']
    
    // 启用自动注册
    registerWithPlugin true
    
    // 只处理包含这些字符串的 JAR
    businessMatchStrings = ['business', 'module']
}
```

---

## 3. LoggerUtils.java - 日志工具

```java
// 包声明
package com.beyondxia.plugin.utils;

/**
 * LoggerUtils 类
 * 
 * 提供简单的日志输出功能
 * 用于插件调试和问题排查
 * 
 * 创建时间：2020/8/3 14:12
 * 作者：WayChen
 * 邮箱：nmnetcw@163.com
 */
public class LoggerUtils {

    /**
     * 输出日志
     * 
     * 使用 System.err.println 输出，确保日志在构建时可见
     * 
     * @param tag 日志标签，用于标识日志来源
     * @param msg 日志消息
     */
    public static void log(String tag, String msg) {
        // 输出格式：[ ModulesPlugin ] tag : msg
        System.err.println("[ ModulesPlugin ] " + tag + " : " + msg);
    }

}
```

### 使用说明

- 使用 `System.err.println` 而不是 `System.out.println`，因为：
  - 错误输出不会被重定向，更容易看到
  - 在 Gradle 构建日志中更明显
- 日志格式统一，便于过滤和查找

---

## 4. SystemUtils.java - 系统工具

```java
// 包声明
package com.beyondxia.plugin.utils;

/**
 * SystemUtils 类
 * 
 * 提供系统相关的工具方法
 * 主要用于处理不同操作系统的路径差异
 * 
 * 创建时间：2018/10/23 17:37
 * 作者：ChenWei
 */
public class SystemUtils {

    /**
     * 判断当前操作系统是否是 Windows
     * 
     * @return true 表示是 Windows 系统，false 表示是其他系统（如 Linux、Mac）
     */
    public static boolean isWindows() {
        // 获取系统属性 "os.name"，转换为大写后检查是否包含 "WINDOWS"
        return System.getProperties().getProperty("os.name").toUpperCase().contains("WINDOWS");
    }

    /**
     * 根据操作系统转换路径分隔符
     * 
     * Windows 使用反斜杠（\），Unix/Linux/Mac 使用正斜杠（/）
     * 这个方法确保路径在不同系统上都能正确使用
     * 
     * @param originPath 原始路径
     * @return 转换后的路径
     */
    public static String getPathByOs(String originPath) {
        // 如果路径为空，返回空字符串
        if (originPath == null) {
            return "";
        }
        
        // 如果是 Windows 系统，将正斜杠转换为反斜杠
        if (isWindows()) {
            return originPath.replace("/", "\\");
        }
        
        // 其他系统直接返回原路径（使用正斜杠）
        return originPath;

    }
}
```

### 使用场景

- **路径转换**：确保路径在不同操作系统上都能正确使用
- **跨平台兼容**：避免因路径分隔符导致的文件找不到问题

### 注意事项

虽然这个工具类存在，但在实际代码中，大部分地方都使用 `replace("\\", "/")` 统一使用正斜杠，因为：
- Java 和 Gradle 都支持正斜杠作为路径分隔符
- 统一使用正斜杠更简单，避免混乱

---

## 5. com.beyondxia.modules.plugin.properties - 插件声明

```
implementation-class=com.beyondxia.plugin.PAServicePlugin
```

### 文件说明

这是 Gradle 插件的声明文件，位于 `META-INF/gradle-plugins/` 目录下。

**文件命名规则：**
- 文件名：`com.beyondxia.modules.plugin.properties`
- 对应的插件 ID：`com.beyondxia.modules.plugin`
- 在 `build.gradle` 中使用：`apply plugin: 'com.beyondxia.modules.plugin'`

**文件内容：**
- `implementation-class`：指定插件的主类
- 当用户应用插件时，Gradle 会加载这个类并调用 `apply()` 方法

### 插件应用流程

```
用户在 build.gradle 中写：apply plugin: 'com.beyondxia.modules.plugin'
  ↓
Gradle 查找 META-INF/gradle-plugins/com.beyondxia.modules.plugin.properties
  ↓
读取 implementation-class=com.beyondxia.plugin.PAServicePlugin
  ↓
加载 PAServicePlugin 类
  ↓
调用 apply(Project project) 方法
  ↓
插件开始工作
```

---

## 6. .gitignore - Git 忽略文件

```
/build
```

### 说明

- `/build`：忽略构建输出目录
- 构建产物不应该提交到版本控制系统

---

## 文件关系图

```
PAServicePlugin (插件入口)
    ↓
PATransform (Transform 实现)
    ↓
    ├── TransformUtil (Javassist 处理)
    │   ├── ClassPool (类池)
    │   ├── @ExportService 注解处理
    │   └── 类继承关系修改
    │
    └── RegisterUtils (ASM 处理)
        ├── 扫描服务类
        ├── 查找 ServiceHelper.class
        └── 注入注册代码
            │
            ├── ClassConstant (常量定义)
            ├── ConfigExtention (配置扩展)
            ├── LoggerUtils (日志工具)
            └── SystemUtils (系统工具)
```
